openapi: 3.0.3
info:
  title: Blocpress Server API
  version: 1.0.0
  description: >
    Blocpress Server provides HTTP APIs for document rendering and related services.
    The API is designed to be extensible; additional endpoints and service domains
    may be added over time without breaking existing integrations.


    **Authentication:** All endpoints require a valid JWT Bearer token. The server
    ships with a built-in dev key (issuer `https://blocpress.dev`). To use your own
    identity provider, override the environment variables `MP_JWT_VERIFY_PUBLICKEY`
    and `MP_JWT_VERIFY_ISSUER` when starting the container.

servers:
  - url: http://localhost:8080/api

security:
  - BearerJWT: []

tags:
  - name: Template
    description: Template handling and document generation

paths:
  /render/template/upload:
    post:
      tags: [ Template ]
      operationId: renderDocumentMultipart
      summary: Generate document from ODT template and JSON data
      description: >
        Upload an ODT template together with JSON data to generate a document in the
        desired output format. This is a stateless endpoint — no template storage required.
      parameters:
        - name: Accept
          in: header
          required: true
          schema:
            type: string
            enum:
              - application/pdf
              - application/rtf
              - application/vnd.oasis.opendocument.text
            example: application/pdf
          description: >
            Desired response media type. Must be one of: application/pdf, application/rtf, 
            application/vnd.oasis.opendocument.text.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - template
                - data
              properties:
                template:
                  type: string
                  format: binary
                  description: ODT template
                data:
                  type: string
                  description: JSON template data
      responses:
        "200":
          description: Generated document (binary) in specified format
          headers:
            Content-Disposition:
              description: download filename
              schema:
                type: string
                example: attachment; filename="generated-document.[pdf|rtf|odt]"
          content:
            application/pdf:
              schema:
                type: string
                format: binary
            application/rtf:
              schema:
                type: string
                format: binary
            application/vnd.oasis.opendocument.text:
              schema:
                type: string
                format: binary
        "400":
          description: Bad request (e.g. missing template, invalid JSON data, or invalid template structure)
        "406":
          description: Unsupported Media Type
        "401":
          description: Unauthorized — missing or invalid JWT
        "500":
          description: Internal server error

  /render/template:
    post:
      tags: [ Template ]
      operationId: renderDocumentJson
      summary: Render document from base64-encoded template and JSON data
      description: >
        Submit a base64-encoded ODT template together with JSON data and desired
        output type to generate a document. Alternative to multipart upload.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RenderRequest'
      responses:
        "200":
          description: Generated document (binary)
          content:
            application/pdf:
              schema:
                type: string
                format: binary
            application/rtf:
              schema:
                type: string
                format: binary
            application/vnd.oasis.opendocument.text:
              schema:
                type: string
                format: binary
        "400":
          description: Bad request
        "401":
          description: Unauthorized — missing or invalid JWT
        "500":
          description: Internal server error

  /render/{id}:
    post:
      tags: [ Template ]
      operationId: renderDocumentById
      summary: Render document using stored template ID
      description: >
        Generate a document using a template that has been uploaded and approved
        in blocpress-workbench. Only APPROVED templates can be used.
        Template content is cached for performance.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Template ID (UUID)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RenderByIdRequest'
      responses:
        "200":
          description: Generated document (binary) in specified format
          content:
            application/pdf:
              schema:
                type: string
                format: binary
            application/rtf:
              schema:
                type: string
                format: binary
            application/vnd.oasis.opendocument.text:
              schema:
                type: string
                format: binary
        "400":
          description: Bad request (invalid JSON data)
        "401":
          description: Unauthorized — missing or invalid JWT
        "403":
          description: Template not approved for rendering
        "404":
          description: Template not found
        "500":
          description: Internal server error

components:
  schemas:
    RenderRequest:
      type: object
      required:
        - template
        - data
        - outputType
      properties:
        template:
          type: string
          format: byte
          description: Base64-encoded ODT template
        data:
          type: object
          description: JSON template data (key-value pairs matching template fields)
        outputType:
          type: string
          enum:
            - pdf
            - rtf
            - odt
          description: Desired output format
    RenderByIdRequest:
      type: object
      required:
        - data
        - outputType
      properties:
        data:
          type: object
          description: JSON template data (key-value pairs matching template fields)
        outputType:
          type: string
          enum:
            - pdf
            - rtf
            - odt
          description: Desired output format
  securitySchemes:
    BearerJWT:
      type: http
      scheme: bearer
      bearerFormat: JWT