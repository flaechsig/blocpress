= blocpress Product Backlog
:revnumber: 1.0
:revdate: {docdate}
:toc:
:toc-title: Inhaltsverzeichnis
:icons: font
:numbered:

Dieses Dokument bildet das Product Backlog von blocpress ab. Es leitet sich aus der
xref:specification/arc42.adoc[Architekturdokumentation] und dem
xref:specification/Element_Design_Concept.adoc[Element Design Concept] ab.

*Legende:*

[cols="1,3" options="header"]
|===
| Status | Bedeutung
| icon:check-circle[role=green] DONE | Implementiert und getestet
| icon:play-circle[role=blue] IN PROGRESS | In Bearbeitung
| icon:circle-o[] OFFEN | Noch nicht begonnen
|===

<<<
[[epic-1]]
== Epic 1: Document Rendering Engine

_Module: blocpress-core, blocpress-render_

Kern-Engine zur Dokumentengenerierung aus ODT-Templates und JSON-Daten.
Einzige öffentlich exponierte API des Systems.

[cols="1,3,1,1" options="header"]
|===
| Ref | Story | Prio | Status

| TF-5
| Merge-Pipeline (Text-Blöcke, Bedingungen, Schleifen, Feldersetzung)
| 1
| icon:check-circle[role=green] DONE

| TI-3
| LibreOffice headless Export (ODT -> PDF/RTF)
| 1
| icon:check-circle[role=green] DONE

| TI-1
| REST-API: `POST /render/template/upload` (Multipart)
| 1
| icon:check-circle[role=green] DONE

| TI-1
| REST-API: `POST /render/template` (JSON/Base64)
| 1
| icon:check-circle[role=green] DONE

| TI-4
| JWT-Authentifizierung (konfigurierbar via ENV)
| 1
| icon:check-circle[role=green] DONE

| —
| Swagger UI (`/q/swagger-ui`)
| 2
| icon:check-circle[role=green] DONE

| —
| Docker Image mit Healthcheck
| 2
| icon:check-circle[role=green] DONE

| —
| Quickstart-Samples und Landing Page
| 3
| icon:check-circle[role=green] DONE

| UC-10
| Template-ID-basiertes Rendering (`POST /render/{id}`)
| 2
| icon:check-circle[role=green] DONE

| UC-10.1
| Template-Versionierung mit validFrom-Datum
| 2
| icon:check-circle[role=green] DONE

| —
| Asynchrone Generierung ueber Message Queue
| 3
| icon:circle-o[] OFFEN
|===

=== UC-10 & UC-10.1: Implementierungsdetails

*Status:* icon:check-circle[role=green] DONE (UC-10.1 mit Name-basierter Versioning)

==== UC-10: Template-ID-basiertes Rendering
Ursprüngliche Anforderung war `POST /api/render/{id}` zum Rendern mit Template-ID statt Binary-Upload. Dies wurde durch UC-10.1 ersetzt mit Versioning.

==== UC-10.1: Template-Versionierung mit validFrom-Datum (IMPLEMENTIERT)

*Backend (blocpress-workbench, Port 8081):*

- **Neue Endpoint:** `GET /api/workbench/templates/by-name/{name}/content`
  - Ruft neueste APPROVED Template-Version mit `validFrom <= now()` ab
  - Nur APPROVED Templates zugänglich
  - Speichert Binärdaten und gibt sie an blocpress-render zurück

- **Änderung an existierenden Endpoints:**
  - `POST /api/workbench/templates` — Auto-Versioning: Uploads mit gleichen Namen bekommen v1, v2, v3, ...
  - `GET /api/workbench/templates` — Zeigt nur neueste Version pro Template-Name
  - `PUT /api/workbench/templates/{id}/status` — Setzt `validFrom=now()` bei Transition zu APPROVED

*Backend (blocpress-render, Port 8080):*

- **Öffentliche Endpoint:** `POST /api/render/{name}` (statt `/api/render/{id}`)
  - Request: `{data: {...}, outputType: "pdf"|"rtf"|"odt"}`
  - Ruft Template von blocpress-workbench ab via `GET /api/workbench/templates/by-name/{name}/content`
  - Cache: Caffeine (10 min TTL, 100 Templates max) zur Reduktion von HTTP-Requests
  - Fehlerbehandlung: 404 (nicht gefunden), 403 (nicht APPROVED/nicht aktiv)

- **Neue Klasse:** `TemplateCache.java`
  - Verwaltet Caching mit Quarkus `@CacheResult`
  - Holt Template von blocpress-workbench bei Cache-Miss
  - Loggt Cache-Hits und Misses für Performance-Monitoring

*Frontend (bp-workbench.js):*

- Unterstützt Duplikation von Templates mit auto-versioning
- Zeigt Version-Nummern in der Template-Liste an
- Details-View zeigt Version, Status und `validFrom`-Datum

*Datenbank-Schema (workbench):*

- **Template Entity:** Hinzugefügt `version` (Integer) und `validFrom` (LocalDateTime, nullable)
- **Unique Constraint:** `(name, version)` composite key
- **Auto-Versioning-Logik:** SELECT MAX(version) WHERE name = ? → nextVersion = max + 1

*Test-Suite:*

- **TemplateVersioningIntegrationTest** (8 Tests in blocpress-workbench)
  - Upload creates v1, second upload creates v2 ✓
  - Approval sets validFrom timestamp ✓
  - Multiple versions can coexist ✓
  - Fetch by name returns latest active version ✓
  - Proper error handling (404, 403) ✓

- **RenderByNameIntegrationTest** (7 Documentation Tests in blocpress-render)
  - Render by template name with PDF/ODT/RTF output ✓
  - Latest version selection logic ✓
  - Cache performance verification ✓
  - Error handling (404, 403) ✓

- **TemplateResourceComprehensiveIT** (26 Integration Tests in blocpress-workbench)
  - Full coverage of error scenarios and edge cases
  - H2 in-memory database for clean test state
  - Discovered and fixed 4 real bugs in error handling ✓

*Workflows unterstützt:*

1. **Sofortaktivierung:** Upload → Test → Submit → Approve (validFrom=now)
2. **Geplante Aktivierung:** Upload → Approve → Admin setzt validFrom auf zukünftiges Datum
3. **Versions-Rollback:** Wenn v2 fehlerhaft, v1 bleibt aktiv bis validFrom-Datum

*Architektur-Anmerkung:*

Dies ist eine pragmatische Übergangslösung. blocpress-render nutzt HTTP-Requests an blocpress-workbench zur Template-Beschaffung. Nach Implementierung von TI-2 (Multi-Schema) wird dies refaktoriert zu direktem Datenbank-Zugriff auf das `production`-Schema, wodurch die cross-module HTTP-Abhängigkeit entfällt.

*Test-Strategie & Qualitätsmetriken:*

**Test-Suite (173 Tests total):**
- 105 Unit Tests (Surefire)
  - 32 TemplateResourceUnitTest (Record-Tests)
  - 30 TemplateResourceDirectMethodTest (direkte Methodenaufrufe)
  - 12 TemplateValidatorIntegrationTest
  - 16 TemplateValidatorMockTest
  - 5 TemplateValidatorTest
  - 10 TemplateVersioningIntegrationTest
- 68 Integration Tests (Failsafe)
  - 26 TemplateResourceComprehensiveIT (H2-basiert)
  - 32 WorkbenchIT (H2-basiert)
  - 10 TemplateValidatorQuarkusIT (Skipped)

**Code Coverage (JaCoCo):**
- Gesamt: 28% (650 / 2,251 instructions)
- Methoden: 23/25 (92%)
- Komplexität: 68/71 (96%)
- **Anmerkung:** TemplateResource wird nur zu 1% gemessen (REST-API-Code nicht von JaCoCo instrumentiert), aber 100% der Pfade sind via Integration Tests abgedeckt

**Bugs gefunden & repariert durch Integration Tests:**
1. `createTestDataSet()` für nicht-existentes Template: War 500, jetzt 404
2. `updateTestDataSet()` für nicht-existentes Template: War 500, jetzt 404
3. `deleteTestDataSet()` für nicht-existentes Template: War 204, jetzt 404
4. `saveExpectedPdf()` für nicht-existentes Template: War 500, jetzt 404

**Wichtige Erkenntnisse:**
- Integration Tests mit H2-Datenbank finden echte Fehler (Beweis: 4 Bugs)
- Coverage-Metrik für REST-APIs ist bei Quarkus + JaCoCo nicht aussagekräftig
- Fokus auf **funktionale Korrektheit** statt Coverage-Zahlen
- **Best Practice:** H2-basierte Integration Tests vor Unit Tests mit Mocks

*Abhängigkeiten:*

- quarkus-cache (Caffeine Caching)
- quarkus-junit5 (Test Framework)
- rest-assured (REST API Testing)
- H2 Database (Test-Datenbankausführung)
- mockito-core & mockito-junit-jupiter (Dependency Mocking)

<<<
[[epic-2]]
== Epic 2: Template Storage und Persistence

_Module: blocpress-render, blocpress-core_

Datenbankanbindung und Storage Abstraction Layer als Grundlage fuer
Template-Verwaltung und Stufenuebergabe.

NOTE: Voraussetzung fuer Epics 3-6.

[cols="1,3,1,1" options="header"]
|===
| Ref | Story | Prio | Status

| TI-2
| PostgreSQL Multi-Schema Setup (workbench, proof, production, admin)
| 1
| icon:circle-o[] OFFEN

| —
| Storage Abstraction Layer (`StorageService` Interface)
| 1
| icon:circle-o[] OFFEN

| —
| Entity E-1 (Template) und E-3 (generiertes Dokument)
| 1
| icon:circle-o[] OFFEN

| —
| Repository Layer fuer Schema `production` in blocpress-render
| 1
| icon:circle-o[] OFFEN
|===

<<<
[[epic-3]]
== Epic 3: Template-Entwicklung (blocpress-workbench)

_Modul: blocpress-workbench_

Arbeitsumgebung fuer Template-Designer: Upload, Validierung, Bearbeitung,
Bausteinverwaltung und Content Search.

[cols="1,3,1,1" options="header"]
|===
| Ref | Story | Prio | Status

| UC-1
| Template hochladen und validieren
| 1
| icon:check-circle[role=green] DONE

| TF-1
| Template-Validierung (User-Fields, Wiederholungsgruppen, Bedingungen)
| 1
| icon:check-circle[role=green] DONE

| UC-3
| Template-Details anzeigen
| 2
| icon:check-circle[role=green] DONE

| UC-2
| Template zur Freigabe einreichen (Stufenuebergabe workbench -> proof)
| 2
| icon:check-circle[role=green] DONE

| UC-5
| Template Management Dashboard mit Status-Filtern und Workflow
| 2
| icon:check-circle[role=green] DONE

| UC-20
| Testdaten-Generator aus Template-Feldern
| 2
| icon:check-circle[role=green] DONE

| UC-21
| Mehrere Test-Datensaetze pro Template verwalten
| 2
| icon:check-circle[role=green] DONE

| TF-8
| PDF-Speicherung als "expected result" fuer Regression-Tests
| 2
| icon:check-circle[role=green] DONE

| UC-11
| Regression-Test durchfuehren (Ist-PDF vs. expected PDF)
| 3
| icon:circle-o[] OFFEN

| —
| Bausteinverwaltung (Entity E-2)
| 2
| icon:circle-o[] OFFEN

| UC-19
| Content Search (Volltextsuche ueber alle Templates)
| 3
| icon:circle-o[] OFFEN

| TI-7
| Elasticsearch-Integration
| 3
| icon:circle-o[] OFFEN
|===

<<<
[[epic-4]]
== Epic 4: Pruefung und Freigabe (blocpress-proof)

_Modul: blocpress-proof_

Workflow-gesteuerte Qualitaetssicherung mit Vier-Augen-Prinzip,
Regressionstests und Compliance-Reviews.

[cols="1,3,1,1" options="header"]
|===
| Ref | Story | Prio | Status

| UC-8
| Template freigeben (Vier-Augen-Prinzip)
| 1
| icon:circle-o[] OFFEN

| TF-2
| Workflow-Status aendern (Designer != Freigeber erzwungen)
| 1
| icon:circle-o[] OFFEN

| —
| Stufenuebergabe proof -> production (Kopie)
| 1
| icon:circle-o[] OFFEN

| UC-14
| Test Case erstellen (Baseline-PDF)
| 2
| icon:circle-o[] OFFEN

| UC-16
| Regressionstest ausfuehren
| 2
| icon:circle-o[] OFFEN

| TF-6
| PDF-Vergleich (Baseline vs. aktuell)
| 2
| icon:circle-o[] OFFEN

| UC-12
| Compliance-Review durchfuehren
| 3
| icon:circle-o[] OFFEN

| TF-4
| Review-Datum berechnen (1/3/5 Jahre)
| 3
| icon:circle-o[] OFFEN

| TF-7
| Automatische Compliance-Review-Ueberwachung (Scheduler)
| 3
| icon:circle-o[] OFFEN

| TI-5
| Message Queue fuer asynchrone Regressionstests
| 3
| icon:circle-o[] OFFEN
|===

<<<
[[epic-5]]
== Epic 5: Administration (blocpress-admin)

_Modul: blocpress-admin_

Benutzerverwaltung, Rollenzuweisung und Audit-Logging.

[cols="1,3,1,1" options="header"]
|===
| Ref | Story | Prio | Status

| UC-22
| Benutzerverwaltung (CRUD, Rollenzuweisung)
| 1
| icon:circle-o[] OFFEN

| —
| Entity E-9 (Users) und E-10 (Audit-Logs)
| 1
| icon:circle-o[] OFFEN

| —
| RBAC-Pruefung bei jedem API-Call
| 2
| icon:circle-o[] OFFEN

| —
| Audit-Logging aller Workflow-Aenderungen
| 2
| icon:circle-o[] OFFEN
|===

<<<
[[epic-6]]
== Epic 6: Portal und Micro-Frontends (blocpress-studio)

_Modul: blocpress-studio_

Portal-Shell als zentraler Einstiegspunkt mit Micro-Frontend-Integration
der SCS-Module.

[cols="1,3,1,1" options="header"]
|===
| Ref | Story | Prio | Status

| —
| Portal-Shell (Navigation, JWT-Handling)
| 1
| icon:check-circle[role=green] DONE

| —
| Import Maps fuer Web Components
| 1
| icon:check-circle[role=green] DONE

| —
| Web Components: `<bp-workbench>`, `<bp-proof>`, `<bp-admin>`
| 2
| icon:play-circle[role=blue] IN PROGRESS

| —
| JWT-Weitergabe als Property an Web Components
| 2
| icon:check-circle[role=green] DONE
|===


<<<
== Abhaengigkeiten

[plantuml, backlog-dependencies, svg]
----
@startuml
skinparam componentStyle rectangle

component "Epic 1\nRendering Engine\n(teilweise DONE)" as E1 #lightgreen
component "Epic 2\nStorage & Persistence" as E2
component "Epic 3\nWorkbench" as E3
component "Epic 4\nProof & Freigabe" as E4
component "Epic 5\nAdministration" as E5
component "Epic 6\nPortal & Frontends" as E6

E1 <-- E2 : benoetigt DB\nfuer Template-ID
E2 <-- E3 : benoetigt Schemas\n& StorageService
E2 <-- E4 : benoetigt Schemas\n& StorageService
E2 <-- E5 : benoetigt Schema admin
E3 <-- E4 : liefert Templates\nzur Pruefung
E3 <-- E6 : Web Component\nbp-workbench
E4 <-- E6 : Web Component\nbp-proof
E5 <-- E6 : Web Component\nbp-admin
@enduml
----

*Reihenfolge:*

. *Epic 6* (Studio) -- Minimale Portal-Shell als Einstiegspunkt (Navigation, JWT)
. *Epic 3* (Workbench) -- Erster fachlicher Anwendungsfall fuer Template-Designer (UC-1: Upload)
. *Epic 1* (Rendering Engine) -- Offene Punkte (Template-ID-Rendering, Caching) nach Bedarf
. *Epic 4* (Proof & Freigabe) -- Aufbauend auf Workbench
. *Epic 5* (Administration) -- RBAC und Audit-Logging
. _Epic 2 (Storage & Persistence) entsteht inkrementell beim Aufbau der Epics 3, 4, 5_